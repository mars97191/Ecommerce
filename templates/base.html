{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Partsix - Auto Parts & Car Accessories Shop HTML Template</title>
    <meta name="description" content="Morden Bootstrap HTML5 Template">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" type="image/x-icon" href="{% static 'assets/img/favicon.ico' %}">

    <!-- ======= All CSS Plugins here ======== -->
    <link rel="stylesheet" href="{% static 'assets/css/plugins/swiper-bundle.min.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/plugins/glightbox.min.css' %}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Open+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,300;1,400;1,500;1,600;1,700&family=Rubik:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,300;1,400;1,500&display=swap"
          rel="stylesheet">

    <!-- Plugin css -->
    <link rel="stylesheet" href="{% static 'assets/css/vendor/bootstrap.min.css' %}">

    <!-- Custom Style CSS -->
    <link rel="stylesheet" href="{% static 'assets/css/style.css' %}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body>


{% include '_include/_header.html' %}

{% block content %} {% endblock %}

{% include '_include/_footer.html' %}


<!-- All Script JS Plugins here  -->
<script src="{% static 'assets/js/vendor/popper.js' %}" defer="defer"></script>
<script src="{% static 'assets/js/vendor/bootstrap.min.js' %}" defer="defer"></script>
<script src="{% static 'assets/js/plugins/swiper-bundle.min.js' %}"></script>
<script src="{% static 'assets/js/plugins/glightbox.min.js' %}"></script>
<script src="{% static 'assets/js/script.js' %}"></script>


<script>
    // wishlist
    $(document).ready(function () {
        // Для каждой кнопки "Добавить в список желаний"
        $('.add-to-wishlist-btn').click(function () {
            // Получаем идентификатор продукта из атрибута data-product-id кнопки
            const productId = $(this).data('product-id');
            let this_val = $(this);


            // Отправляем AJAX-запрос на сервер для добавления продукта в список желаний
            $.ajax({
                url: `/wishlist/add/${productId}/`,
                type: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'), // Получаем CSRF-токен
                },
                success: function (response) {
                    // Обработка ответа от сервера
                    if (response.success) {
                        // Если запрос успешен, выполните необходимые действия (например, обновите интерфейс)
                        this_val.html("❤️");
                        console.log('Продукт успешно добавлен в список желаний');
                        $(".item_wishlist").text(response.wishlist_count);

                    } else {
                        // В случае ошибки выводим сообщение об ошибке
                        console.error('Ошибка добавления продукта в список желаний');
                    }
                },
                error: function (error) {
                    console.error('Ошибка добавления продукта в список желаний:', error);
                }
            });
        });

        $('.wishlist__remove--btn').click(function () {
            // Получаем кнопку, на которую был совершен клик
            const button = $(this);

            // Получаем идентификатор продукта из атрибута data-product кнопки
            const productId = button.data('product');

            // Отправляем AJAX-запрос на сервер для удаления продукта из списка желаний
            $.ajax({
                url: `/wishlist/remove/${productId}/`,
                type: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'), // Получаем CSRF-токен из мета-тега
                },
                success: function (response) {
                    // Обработка ответа от сервера
                    if (response.success) {
                        // Если запрос успешен, удаляем элемент списка желаний из DOM
                        button.closest('.cart__table--body__items').remove();
                        console.log("Продукт успешно удален из списка желаний");
                        $(".item_wishlist").text(response.wishlist_count);
                    } else {
                        // В случае ошибки выводим сообщение об ошибке
                        console.error('Ошибка удаления продукта из списка желаний');
                    }
                },
                error: function (error) {
                    console.error('Ошибка удаления продукта из списка желаний:', error);
                }
            });
        });

        // Функция для получения CSRF-токена из куки
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Ищем куки с именем 'name'
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }


    });
</script>

<!--добавление в корзину корзины -->
<script>
    $(document).ready(function () {

        // Обработка добавления в корзину на главной странице
        $(document).on('click', '.add-button', function (e) {
            e.preventDefault();

            // Значение по умолчанию для количества товара
            const productQty = 1;

            // Получаем id продукта из значения кнопки
            const product_id = $(this).val();  // Получаем значение кнопки, которое является ID продукта
            console.log("Product ID:", product_id);

            // Сохраняем текущую кнопку для изменения ее текста позже
            const addButton = $(this);


            $.ajax({
                type: 'POST',
                url: '{% url "cart:add-to-cart" %}',
                data: {
                    product_id: product_id,
                    product_qty: productQty,
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                    action: 'post'
                },
                success: function (response) {
                    $('#lblCartCount').text(response.qty);  // Обновляем количество товаров в корзине
                    // Изменяем состояние кнопки
                    addButton.prop('disabled', true);
                    addButton.text("Товар добавлен");
                    addButton.removeClass('btn-secondary').addClass('btn-success');
                    console.log("Button Updated:", addButton);
                },
                error: function (error) {
                    console.log(error);
                }
            });
        });


        $(document).on('click', '#add-to-cart-detail', function (e) {
            e.preventDefault();

            const product_id = $(this).val();  // Получаем значение кнопки, которое является ID продукта
            const product_qty = $('#product-quantity option:selected').val();  // Получаем выбранное количество продукта
            // Сохраняем текущую кнопку для изменения ее текста позже
            const addButton = $(this);
            $.ajax({
                type: 'POST',
                url: '{% url "cart:add-to-cart" %}',
                data: {
                    product_id: product_id,
                    product_qty: product_qty,
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                    action: 'post'
                },
                success: function (response) {
                    $('#lblCartCount').text(response.qty);  // Обновляем количество товаров в корзине
                    addButton.prop('disabled', true);
                    addButton.text("Товар добавлен");
                    addButton.removeClass('btn-secondary').addClass('btn-success');
                },
                error: function (error) {
                    console.log(error);
                }
            });
        });
    });
</script>


<!--удаление из корзины -->
<script>
    // Удаление товара из корзины
    $(document).on('click', '.delete-button', function (e) {
        e.preventDefault();

        const productId = $(this).data('index');  // Получаем id продукта для удаления
        const this_button = $(this);  // Сохраняем текущую кнопку удаления

        console.log("Deleting product with ID:", productId);

        $.ajax({
            type: "POST",
            url: "{% url 'cart:remove_from_cart' %}",
            data: {
                product_id: productId,
                action: 'post',
                csrfmiddlewaretoken: "{{ csrf_token }}"
            },
            success: function (response) {
                console.log("Success response:", response);
                // Добавьте обработку успешного удаления здесь

                if (response.status === 'success') {
                    // Успешно удален товар из корзины
                    this_button.closest(".cart__table--body__items").remove(); // Удаляем строку с товаром из DOM
                    $("#cart-total-amount").text(response.total);
                    document.getElementById('lblCartCount').textContent = response.qty;


                } else {
                    // Если произошла ошибка при удалении товара из корзины
                    console.log("Error removing product from cart:", response.message);
                }
            },
        });
    });
</script>

<!--обновление корзины -->
<script>
        $(document).ready(function () {
    // Обработчик нажатия кнопки +
    $(document).on('click', '.quantity__value.increase', function () {
        const input = $(this).siblings('.quantity__number');
        changeQuantity(input, 1); // Увеличиваем количество на 1
    });

    // Обработчик события нажатия кнопки -
    $(document).on('click', '.quantity__value.decrease', function () {
        const input = $(this).siblings('.quantity__number');
        changeQuantity(input, -1); // Уменьшаем количество на 1
    });

    // Функция изменения количества товара
    function changeQuantity(input, change) {
        const currentValue = parseInt(input.val());
        if (!isNaN(currentValue)) {
            const newValue = currentValue + change;
            if (newValue >= 1) {
                input.val(newValue).trigger('change'); // Вызываем событие изменения
            }
        }
    }

    // Обработчик события изменения количества товара
    $(document).on('change', '.quantity__number', function () {
        const productId = $(this).data('product-id');
        const quantity = parseInt($(this).val());
        const productRow = $(this).closest('.cart__table--body__items');

        if (!isNaN(quantity) && quantity > 0) {
            const priceText = productRow.find('.cart__price').first().text();
            const pricePerItem = parseFloat(priceText.replace(/[^0-9.-]+/g, ''));
            if (!isNaN(pricePerItem)) {
                const total = quantity * pricePerItem;
                productRow.find('.cart__price.end').text(total.toFixed(1));

                // Обновляем общую сумму корзины
                updateCartTotal();

                // Обновляем количество товаров в корзине
                updateCartCount();

                // Отправляем данные на сервер для обновления корзины
                updateCartOnServer(productId, quantity);
            }
        }
    });

    // Функция для обновления общей суммы корзины
    function updateCartTotal() {
        let totalAmount = 0;
        $('.cart__table--body__items').each(function () {
            const quantity = parseInt($(this).find('.quantity__number').val());
            const priceText = $(this).find('.cart__price').first().text();
            const pricePerItem = parseFloat(priceText.replace(/[^0-9.-]+/g, ''));
            if (!isNaN(quantity) && !isNaN(pricePerItem)) {
                totalAmount += quantity * pricePerItem;
            }
        });
        $('#cart-total-amount').text(totalAmount.toFixed(1));
    }

    // Функция для обновления количества товаров в корзине
    function updateCartCount() {
        let totalQuantity = 0;
        $('.quantity__number').each(function () {
            const quantity = parseInt($(this).val());
            if (!isNaN(quantity)) {
                totalQuantity += quantity;
            }
        });
        $('#lblCartCount').text(totalQuantity);
    }

    // Функция для отправки данных на сервер
    function updateCartOnServer(productId, quantity) {
        $.ajax({
            url: '{% url "cart:update-cart-quantity" %}',  // Замените на актуальный URL вашего представления
            method: 'POST',
            data: {
                'action': 'post',
                'product_id': productId,
                'product_qty': quantity,
                'csrfmiddlewaretoken': '{{ csrf_token }}'  // Передаем токен CSRF для защиты
            },
            success: function(response) {
                // Обрабатываем успешный ответ сервера, если необходимо
                console.log('Корзина обновлена на сервере', response);
            },
            error: function(xhr, status, error) {
                // Обрабатываем ошибки
                console.error('Ошибка при обновлении корзины на сервере:', error);
            }
        });
    }
});

    </script>

</body>
</html>